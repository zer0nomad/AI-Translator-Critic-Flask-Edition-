================================================================================
    AI TRANSLATOR & CRITIC - АВТОТЕСТЫ (AQA Documentation)
================================================================================

ОБЗОР ТЕСТИРОВАНИЯ
==================
Проект использует автоматизированное тестирование на базе pytest для валидации
функциональности Flask приложения "AI Translator & Critic".

СТРУКТУРА ТЕСТОВ
================
tests/
├── conftest.py              - Конфигурация pytest, фикстуры и моки
├── test_app.py              - Основные тесты приложения
└── test_api_integration.py   - Тесты интеграции с API

УСТАНОВКА И ЗАПУСК
==================
1. Установить зависимости для тестирования:
   pip install -r requirements.txt
   pip install pytest pytest-mock pytest-cov

2. Запустить все тесты:
   pytest tests/ -v

3. Запустить тесты с покрытием кода:
   pytest tests/ --cov=src --cov-report=html

4. Запустить конкретный тестовый файл:
   pytest tests/test_app.py -v

5. Запустить конкретный тест:
   pytest tests/test_app.py::test_index_get -v

КАТЕГОРИИ ТЕСТОВ
================

1. ФУНКЦИОНАЛЬНЫЕ ТЕСТЫ (test_app.py)
   - Тестирование GET запросов (загрузка формы)
   - Тестирование POST запросов (обработка данных)
   - Тестирование обработки ошибок
   - Тестирование валидации входных данных

2. ТЕСТЫ ИНТЕГРАЦИИ С API (test_api_integration.py)
   - Проверка корректности построения HTTP запроса к API
   - Тестирование обработки ответов от API
   - Тестирование обработки ошибок сети
   - Проверка правильности использования API ключа в заголовках

3. ТЕСТЫ БЕЗОПАСНОСТИ
   - Проверка, что API ключ не логируется в консоли
   - Проверка использования переменных окружения (.env)
   - Валидация заголовков Authorization

ОПИСАНИЕ ТЕСТОВ
===============

ГРУППА 1: Базовые функциональные тесты
---
test_index_get_returns_form
  Описание: Проверяет, что GET / возвращает HTML форму
  Ожидаемое: Статус 200, в ответе содержится форма с textarea и select

test_post_with_empty_text_returns_error
  Описание: Проверяет обработку пустого текста при POST запросе
  Ожидаемое: Статус 200, в ответе ошибка "Пожалуйста, введите текст"

test_post_with_valid_data_triggers_api_call
  Описание: Проверяет, что POST с валидными данными вызывает API
  Ожидаемое: Функция call_llm вызывается дважды (перевод и оценка)

test_language_selection_works
  Описание: Проверяет различные варианты выбора языка
  Ожидаемое: Форма принимает все три языка (Английский, Французский, Немецкий)

ГРУППА 2: Тесты обработки ошибок
---
test_api_error_500_handled_gracefully
  Описание: Проверяет обработку ошибки 500 от API
  Ожидаемое: Отображается сообщение об ошибке, приложение не падает

test_api_timeout_handled
  Описание: Проверяет обработку таймаута при обращении к API
  Ожидаемое: Отображается сообщение "Таймаут при обращении к API"

test_missing_api_key_returns_error
  Описание: Проверяет поведение при отсутствии API ключа
  Ожидаемое: Функция call_llm возвращает None

ГРУППА 3: Тесты обработки markdown
---
test_markdown_processing_in_evaluation
  Описание: Проверяет, что markdown в оценке обрабатывается в HTML
  Ожидаемое: ** преобразуется в <strong>, # в <h2> и т.д.

test_markdown_escaping_for_security
  Описание: Проверяет, что вредоносный HTML в markdown не выполняется
  Ожидаемое: HTML теги экранируются и отображаются как текст

ГРУППА 4: Тесты API интеграции
---
test_api_request_headers_correct
  Описание: Проверяет правильность заголовков в запросе к API
  Ожидаемое: Authorization: Bearer <KEY>, Content-Type: application/json

test_api_request_payload_format
  Описание: Проверяет структуру JSON payload для API
  Ожидаемое: {"model_name": "...", "prompt": "..."}

test_translation_prompt_structure
  Описание: Проверяет структуру промпта для модели-переводчика
  Ожидаемое: Промпт содержит инструкцию и исходный текст

test_judge_prompt_includes_translation
  Описание: Проверяет, что промпт для судьи содержит оригинал и перевод
  Ожидаемое: Промпт содержит оба текста для сравнения

MOCK ОБЪЕКТЫ И ФИКСТУРЫ
=======================

@pytest.fixture
def client
  Возвращает Flask test client для отправки HTTP запросов

@pytest.fixture
def mock_api_response
  Возвращает моковый успешный ответ от API

@pytest.fixture
def mock_call_llm
  Мокирует функцию call_llm для тестирования без реального API

ПРИМЕРЫ ЗАПУСКА
===============

Запустить все тесты:
  $ pytest tests/ -v

Запустить тесты с покрытием:
  $ pytest tests/ --cov=src --cov-report=html

Запустить только функциональные тесты:
  $ pytest tests/test_app.py -v

Запустить только тесты API:
  $ pytest tests/test_api_integration.py -v

Запустить тесты с прохождением только критических:
  $ pytest tests/ -m "critical" -v

Запустить с выводом print() и логов:
  $ pytest tests/ -v -s

МЕТРИКИ КАЧЕСТВА
================
Целевое покрытие кода: 85%
Критические функции для покрытия:
  - call_llm() - 100%
  - process() - 95%
  - Обработка ошибок - 100%

ИНТЕГРАЦИЯ С CI/CD
==================
Тесты могут быть запущены в CI/CD пайпелайне:

GitHub Actions пример:
  name: Run Tests
  on: [push, pull_request]
  jobs:
    test:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v2
        - name: Install dependencies
          run: pip install -r requirements.txt
        - name: Run tests
          run: pytest tests/ -v --cov=src

ИЗВЕСТНЫЕ ПРОБЛЕМЫ И ОГРАНИЧЕНИЯ
=================================
1. Тесты используют моки для API запросов - реальные запросы не выполняются
2. Таймауты в тестах установлены в 5 секунд для быстрого выполнения
3. Переменная окружения API_KEY должна быть установлена для некоторых тестов

РЕКОМЕНДАЦИИ ДЛЯ QA
===================
1. Перед коммитом всегда запускать: pytest tests/ -v
2. Добавлять новый тест для каждого найденного бага
3. Использовать -s флаг для отладки: pytest tests/ -v -s
4. Проверять покрытие: pytest --cov=src tests/
5. Документировать все граничные случаи

КОНТАКТЫ И ПОДДЕРЖКА
====================
При возникновении проблем с тестами:
1. Проверьте наличие зависимостей: pip install pytest pytest-mock
2. Убедитесь, что .env файл содержит валидный API ключ
3. Запустите тесты с флагом -v для более подробного вывода
4. Проверьте логи в src/app.py для отладки

Дата создания: 16 декабря 2025
Версия документации: 1.0
================================================================================
